# LinearStaticSolver 仕様ドキュメント

最終更新: 2025-10-11

## 概要
`LinearStaticSolver` は 3D ビーム/フレーム要素の線形静解析を行うソルバーです。  
全体剛性マトリクスと荷重ベクトルを組み立て、境界条件を考慮したうえで自由自由度の連立一次方程式を解き、節点変位ベクトルを返します。

- 対応解析: 線形静解析（小変形）
- 要素: 3D ビーム（各節点6自由度）
- ライブラリ: MathNet.Numerics (線形代数)

## 単位と前提
- 単位系は N–mm 系を前提（推奨）
  - E: N/mm^2, 長さ: mm, 断面二次モーメント: mm^4, 荷重: N（点）、q: N/mm（等分布）
- 各節点の自由度（DOF）順序は以下:
  - 0: UX, 1: UY, 2: UZ, 3: RX, 4: RY, 5: RZ
- 全体変位ベクトルのインデックス:
  - 節点 i（モデル内のリストインデックス）に対して、グローバルDOFは `i * 6 + dofLocal`（dofLocal は上表）  

例: 節点 id=1 が Nodes リストのインデックス 1 に配置されている場合、節点2の Y 変位は `disp[1*6 + 1] == disp[7]`

## 実装概要

### 1) 剛性行列の組立 (AssembleGlobalStiffness)
- 各要素からローカル剛性 `keLocal` を取得
- 要素の座標変換行列 `T`（12x12）で全体座標へ変換: `K_e_global = T * keLocal * T^T`
- 要素が接続する節点の Nodes リスト内インデックスを求め、全体剛性 `globalK` にアセンブル
  - 重要: ノードIDとリストインデックスは一致しない可能性があるため、`FindIndex(n => n.Id == id)` でマッピング

### 2) 荷重ベクトルの組立 (AssembleGlobalLoad)
- 点荷重 (`PointLoad`)
  - 節点ID → Nodes リストインデックスを取得し、対応する6DOFに加算（モーメントも同）
- 要素荷重 (`ElementLoad`)
  - ローカル座標系の等価節点荷重ベクトル `feLocal`（12成分）を生成
  - 全体座標へ変換: `feGlobal = T * feLocal`
  - 接続節点の全体ベクトルへ加算

### 3) 境界条件と解法 (solve)
- サポート (`Support.Conditions[6]`) に基づき、固定DOF（既知=0）と自由DOFを分離
- 自由自由度サブマトリクス `kff` と荷重 `ff` を抽出
- ランク検査（SVD）で特異/劣条件を検出
  - `rank < n` のとき詳細なゼロモード診断（寄与の大きいDOFを例外メッセージに列挙）
- `kff.Solve(ff)` を解き、全体変位ベクトルにマッピング
- NaN/Inf 検査により異常を即時例外化

### 4) 支持ばね（任意, ペナルティ法）
- `Support.Stiffness[6]` が正値の場合、対応DOFの全体剛性対角要素へ加算
- 単位に注意（回転は N·mm/rad 相当）

### 5) 回転自由度の正則化（任意）
3D モデルでは、理想的なピン・ローラー支持だと剛体回転モードが残ることがあります。  
`EnableRegularization = true` で回転自由度（RX, RY, RZ）に微小剛性を自動付与し、機構を潰します。

- 代表回転剛性（中央値）を算出:
  - `E*Iyy/L`, `E*Izz/L`, `G*J/L` の集合から中央値を `kref` とする
- 実際に対角加算する値: `kreg = kref * RotationalRegularizationFactor`（既定 `1e-9`）
- 拘束されていない回転DOFにのみ加算（過拘束回避）

使用例: