# Grasshopper コンポーネント UI デザインガイドライン

最終更新: 2025-01-13

## 概要

このドキュメントは、FEMur プロジェクトにおける Grasshopper コンポーネントのカスタムUIを実装する際のデザインガイドラインとコーディング規約を定めるものです。

## 目次

1. [UIレイアウト定数](#uiレイアウト定数)
2. [コンポーネント構造](#コンポーネント構造)
3. [UI要素の実装](#ui要素の実装)
4. [コーディング規約](#コーディング規約)
5. [実装例](#実装例)
6. [チェックリスト](#チェックリスト)

---

## UIレイアウト定数

### 基本原則

- すべてのレイアウト関連の数値は定数として定義する
- 定数名は役割が明確に分かるように命名する
- カテゴリごとにグループ化して管理する
- 単位は基本的にピクセル（float型）

### 標準的な定数セット

以下は、展開可能なタブメニューを持つコンポーネントの標準的な定数セットです：

**コンポーネント境界からの距離**
- `COMPONENT_MARGIN_HORIZONTAL = 2f` : 左右の余白
- `COMPONENT_MARGIN_VERTICAL = 4f` : 上下の余白

**タブ設定**
- `TAB_HEIGHT = 14f` : タブの高さ
- `TAB_MARGIN_TOP = 4f` : タブ上部の余白

**メニュー内の余白とサイズ**
- `MENU_LEFT_MARGIN = 5f` : メニュー左側の余白
- `MENU_TOP_PADDING = 5f` : タブ下からメニュー開始までの余白

**チェックボックス・ラジオボタン設定**
- `CONTROL_SIZE = 10f` : チェックボックス・ラジオボタンのサイズ
- `CONTROL_RIGHT_MARGIN = 25f` : 右端からの距離
- `CONTROL_FILL_MARGIN = 2f` : 塗りつぶし時の内側余白（チェックボックス）
- `RADIO_FILL_MARGIN = 3f` : 塗りつぶし時の内側余白（ラジオボタン）

**行間隔**
- `LINE_HEIGHT_NORMAL = 14f` : 通常の行間隔
- `LINE_HEIGHT_SECTION = 18f` : セクション間の行間隔

**メニュー全体の高さ**
- `MENU_CONTENT_HEIGHT` : 展開時のメニューコンテンツの高さ（内容に応じて計算）

**色設定**
- `TAB_BACKGROUND_COLOR = Color.FromArgb(80, 80, 80)` : タブ背景色（濃いグレー）
- `CONTROL_FILL_COLOR = Color.FromArgb(80, 80, 80)` : チェック・選択時の塗りつぶし色
- `TEXT_COLOR = Color.Black` : テキスト色
- `TAB_TEXT_COLOR = Color.White` : タブテキスト色

### 定数の命名規則

| カテゴリ | プレフィックス/サフィックス | 例 |
|---------|---------------------------|-----|
| マージン | `MARGIN_` | `COMPONENT_MARGIN_HORIZONTAL` |
| パディング | `PADDING_` | `MENU_TOP_PADDING` |
| 高さ | `HEIGHT_` | `TAB_HEIGHT`, `LINE_HEIGHT_NORMAL` |
| サイズ | `SIZE_` | `CONTROL_SIZE` |
| 色 | `_COLOR` (サフィックス) | `TAB_BACKGROUND_COLOR` |

---

## コンポーネント構造

### 基本クラス構成

コンポーネントは2つのクラスから構成されます：

1. **コンポーネントクラス** (`GH_Component` を継承)
   - ロジックとデータを管理
   - 入力・出力パラメータの定義
   - 計算処理の実装

2. **属性クラス** (`GH_ComponentAttributes` を継承)
   - UIの描画とレイアウト
   - ユーザーインタラクションの処理

### コンポーネントクラスのテンプレート

コンポーネントクラス名: `{機能名}` (例: `SectionForceView`)

属性クラス名: `{コンポーネント名}Attributes` (例: `SectionForceViewAttributes`)

### 属性クラスの基本構造

属性クラスは以下のリージョンで構成します：

1. `UI Layout Constants` - UI定数
2. `Fields` - フィールド
3. `Constructor` - コンストラクタ
4. `Layout Methods` - レイアウトメソッド
5. `Rendering Methods` - 描画メソッド
6. `Event Handlers` - イベントハンドラ

---

## UI要素の実装

### 1. 展開可能なタブ

#### レイアウト計算

タブの位置とサイズは `Layout()` メソッドで計算します：

**ポイント:**
- 展開状態に応じて `extraHeight` を計算
- タブの位置は `bounds.Bottom - extraHeight + TAB_MARGIN_TOP`
- 展開時は `Layout()` を再呼び出し

#### タブの描画

タブは以下の順序で描画します：

1. `GH_Capsule` で基本形状を描画
2. カスタム背景色で上書き
3. テキストを中央揃えで描画

**注意点:**
- `GH_Capsule` は必ず `Dispose()` する
- エラー/警告時は `GH_Palette` を変更

### 2. チェックボックス

#### デザイン仕様

- サイズ: `CONTROL_SIZE × CONTROL_SIZE` の正方形
- 未チェック: 白背景に黒枠
- チェック済み: 内側を `CONTROL_FILL_COLOR` で塗りつぶし
- 内側の余白: `CONTROL_FILL_MARGIN`

#### 配置

- 右端から `CONTROL_RIGHT_MARGIN` の位置
- ラベルは左端から `MENU_LEFT_MARGIN` の位置

#### クリック処理

トグル動作（ON/OFF切り替え）を実装します。

### 3. ラジオボタン

#### デザイン仕様

- サイズ: `CONTROL_SIZE × CONTROL_SIZE` の円形
- 未選択: 白背景に黒枠の円
- 選択済み: 内側を `CONTROL_FILL_COLOR` で塗りつぶした小さい円
- 内側の余白: `RADIO_FILL_MARGIN`
- アンチエイリアス: 有効にして滑らかに描画

#### 選択肢の管理

列挙型（enum）で選択肢を定義し、1つだけ選択可能にします。

#### クリック処理

- 未選択の項目をクリック: その項目を選択
- 選択済みの項目をクリック: `None` に戻す（トグル動作）

---

## コーディング規約

### 1. 命名規則

#### クラス名

- コンポーネントクラス: `{機能名}` (PascalCase)
- 属性クラス: `{コンポーネント名}Attributes` (PascalCase)

#### 定数

- すべて大文字
- 単語をアンダースコアで区切る
- 例: `COMPONENT_MARGIN_HORIZONTAL`, `TAB_HEIGHT`

#### メソッド

- PascalCase を使用
- 役割を明確に示す動詞を使用
- 例: `RenderTab()`, `DrawCheckBox()`, `HandleCheckBoxClick()`

#### フィールド

- camelCase を使用
- private フィールドには接頭辞を付けない
- 例: `sectionForcesExpanded`, `filledCheckBox`

### 2. リージョンの使用

関連する要素は必ずリージョンでグループ化します：

**必須リージョン:**
- `UI Layout Constants` - UI定数の定義
- `Fields` - フィールドの定義

**推奨リージョン:**
- `Layout Methods` - レイアウト計算メソッド
- `Rendering Methods` - 描画メソッド
- `Event Handlers` - イベント処理メソッド

### 3. XMLドキュメントコメント

すべてのpublicおよびprotectedメソッドにXMLコメントを記述します。

**必須項目:**
- `summary` - メソッドの説明
- `param` - パラメータの説明（ある場合）
- `returns` - 戻り値の説明（ある場合）

### 4. メソッドの分割

#### 単一責任の原則

各メソッドは1つの役割のみを持つように分割します：

- `Layout()` - レイアウト計算の統括
- `Render()` - 描画の統括
- `RenderTab()` - タブの描画
- `RenderMenuContent()` - メニューコンテンツの描画
- `DrawCheckBox()` - チェックボックスの描画
- `DrawRadioButton()` - ラジオボタンの描画

#### ヘルパーメソッドの作成

共通処理は積極的にヘルパーメソッドに抽出します：

- `CreateControlRect()` - コントロール矩形の生成
- `DrawRadioButtonWithLabel()` - ラジオボタンとラベルをセットで描画
- `HandleCheckBoxClick()` - チェックボックスのクリック処理
- `HandleRadioButtonClick()` - ラジオボタンのクリック処理

### 5. リソース管理

#### using ステートメント

`IDisposable` を実装するオブジェクトは必ず `using` で囲みます：

**対象オブジェクト:**
- `SolidBrush`
- `Pen`
- `Graphics` (特定の場合)
- `Font` (新規作成した場合)

#### GH_Capsule の破棄

`GH_Capsule` は必ず明示的に `Dispose()` を呼び出します。

### 6. パフォーマンス考慮事項

#### 描画の最適化

- `Render()` メソッド内で重い処理を避ける
- 可能な限り `Layout()` で計算を済ませる
- 頻繁に作成されるオブジェクトは使い回しを検討

#### メモリリーク防止

- イベントハンドラの登録解除を忘れない
- 大きなオブジェクトは適切に破棄する

---

## 実装例

### 展開可能なタブメニューの完全実装

参考実装: `FEMur.GH\Results\SectionForceView.cs`

この実装には以下が含まれます：

1. 展開可能なタブ
2. チェックボックス（2つ）
3. ラジオボタン（6つ、1つのみ選択可能）
4. 適切なリージョン分割
5. ヘルパーメソッドの活用
6. XMLドキュメントコメント

### 主要メソッドの実装パターン

#### Layout() メソッド

レイアウト計算の基本パターン：

1. `base.Layout()` を呼び出し
2. コンポーネントのバウンドを取得
3. 追加の高さを計算
4. タブの位置を計算
5. 展開時はメニュー要素の位置を計算

#### Render() メソッド

描画処理の基本パターン：

1. `base.Render()` を呼び出し
2. `GH_CanvasChannel.Objects` チャネルで描画
3. タブを描画
4. 展開時はメニューコンテンツを描画

#### RespondToMouseDown() メソッド

イベント処理の基本パターン：

1. 左クリックのみ処理
2. タブクリックで展開/折りたたみ
3. 展開時は各コントロールのクリックを処理
4. 処理した場合は `GH_ObjectResponse.Handled` を返す
5. 処理しない場合は `base.RespondToMouseDown()` を呼び出し

---

## チェックリスト

### 設計フェーズ

- [ ] UI要素の配置を決定
- [ ] 必要な定数を洗い出し
- [ ] カラースキームを決定
- [ ] 状態管理の方法を決定（bool, enum等）

### 実装フェーズ

**定数定義**
- [ ] すべての定数を `#region UI Layout Constants` に定義
- [ ] 適切な命名規則に従っているか確認
- [ ] カテゴリごとにグループ化されているか確認

**クラス構造**
- [ ] リージョンでコードを整理
- [ ] フィールドを適切に定義
- [ ] プロパティで Owner を定義

**メソッド実装**
- [ ] メソッドを単一責任に分割
- [ ] ヘルパーメソッドを適切に活用
- [ ] XMLドキュメントコメントを記述

**リソース管理**
- [ ] すべての `using` ステートメントが正しく使用されている
- [ ] `GH_Capsule` が適切に破棄されている
- [ ] イベントハンドラが適切に登録/解除されている

### テストフェーズ

**機能テスト**
- [ ] タブの展開/折りたたみが正常に動作
- [ ] すべてのクリック領域が正しく反応
- [ ] チェックボックスのトグル動作が正常
- [ ] ラジオボタンの排他選択が正常

**UI/UXテスト**
- [ ] レイアウトが崩れていないか確認
- [ ] エラー/警告時のパレット色が正しく表示
- [ ] テキストが読みやすいか確認
- [ ] コントロールのサイズが適切か確認

**パフォーマンステスト**
- [ ] 描画処理が重くないか確認
- [ ] メモリリークがないか確認

### コードレビュー

**命名規則**
- [ ] クラス名が適切か
- [ ] メソッド名が役割を表しているか
- [ ] 定数名が明確か

**コメント**
- [ ] XMLドキュメントコメントが完備されているか
- [ ] 複雑な処理に説明コメントがあるか

**コード品質**
- [ ] 重複コードがないか
- [ ] メソッドが長すぎないか（目安: 50行以内）
- [ ] ネストが深すぎないか（目安: 3階層以内）

---

## よくある問題と解決策

### 問題1: タブクリック時にサイズが変わらない

**原因:** `Layout()` メソッドを再呼び出ししていない

**解決策:** タブクリック時に `Layout()` を明示的に呼び出す

### 問題2: チェックボックスが反応しない

**原因:** クリック判定の矩形領域が小さすぎる、またはオフセットがずれている

**解決策:** デバッグ時に矩形領域を可視化して確認

### 問題3: 色が正しく表示されない

**原因:** `GH_Capsule` のデフォルト色が上書きされていない

**解決策:** `GH_Capsule.Render()` の後に明示的に色を描画

### 問題4: メモリリーク

**原因:** `Dispose()` を呼び忘れている

**解決策:** すべての `IDisposable` オブジェクトを `using` で囲む

---

## 参考資料

### プロジェクト内の実装例

- `FEMur.GH\Results\SectionForceView.cs` - 完全な実装例（展開タブ + チェックボックス + ラジオボタン）
- `FEMur.GH\Results\ResultView.cs` - シンプルな実装例

### Grasshopper SDK

- [Grasshopper API Documentation](https://developer.rhino3d.com/api/grasshopper/)
- `GH_Component` クラス
- `GH_ComponentAttributes` クラス
- `GH_Capsule` クラス

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-01-13 | 1.0.0 | 初版作成 |

---

## 貢献者向けガイド

このドキュメントの改善提案は以下の方法で行ってください：

1. 新しいUIパターンを追加する場合は、実装例も含める
2. 定数値を変更する場合は、理由を明記する
3. 実装例は実際に動作するコードを記載する
4. スクリーンショットがあるとより分かりやすい

---

## ライセンス

このドキュメントは FEMur プロジェクトの一部であり、プロジェクトと同じライセンスが適用されます。